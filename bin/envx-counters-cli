#!/bin/sh

## Default values
HOST="127.0.0.1"
PORT="8907"
SELF="$0"

usage(){
    echo "\
Command line tool for reading counter values from
running instances of the envx_counters Erlang application.

Usage:
\t$SELF -h | --help        show this memo;
\t$SELF [options] list     list available counters;
\t$SELF [options] dump     get current values for all counters.
\t$SELF [options] get COUNTER_NAME [COUNTER_NAME [...]]
\t                         get current value for specified counters;
\t$SELF [options] reset    drop all counters to zero.

Options are:
\t--host HOSTNAME       set hostname or IP address. Default is $HOST;
\t--port PORT_NUMBER    set TCP port number. Default is $PORT."
}

CMD=""
while [ -z "$CMD" -a $# -gt 0 ]; do
    case "$1" in
        -h | --help)
	    usage; exit 0 ;;
        --host)
	    HOST="$2"
	    shift ;;
        --port)
	    PORT="$2"
	    shift ;;
	-*)
	    echo "error: unknown option: $1" 1>&2; exit 1 ;;
	*)
	    CMD="$1"
	    ;;
    esac
    shift
done

case "$CMD" in
    list)
	echo "list"   | socat STDIO "tcp:$HOST:$PORT" | tr ' ' '\n' | sort ;;
    dump)
	echo "dump"   | socat STDIO "tcp:$HOST:$PORT" | sort ;;
    get)
        while [ $# -gt 0 ]; do
            echo "get $1"
            shift
        done | socat STDIO "tcp:$HOST:$PORT" ;;
    reset)
	echo "reset"  | socat STDIO "tcp:$HOST:$PORT" | sort ;;
    *)
        echo "error: invalid command: $CMD" 1>&2
        usage; exit 1 ;;
esac
